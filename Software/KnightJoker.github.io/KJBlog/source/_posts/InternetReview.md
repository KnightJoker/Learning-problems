title: TCP/IP学习笔记（一）
description: Transmission Control Protocol/Internet Protocol的简写，中译名为传输控制协议/因特网互联协议，又名网络通讯协议，是Internet最基本的协议、Internet国际互联网络的基础，由网络层的IP协议和传输层的TCP协议组成。
categories: 
- 计算机基础
tags:
- TCP/IP

---

在学习之前需要知道的几个概念：

- *IP地址* <br>网络上每一个节点都必须有一个独立的Internet地址（也叫做IP地址）。现在，通常使用的IP地址是一个32bit的数字，也就是我们常说的IPv4标准，这32bit的数字分成四组，也就是常见的255.255.255.255的样式。IPv4标准上，地址被分为五类，我们常用的是B类地址。具体的分类请参考其他文档。需要注意的是IP地址是网络号+主机号的组合，这非常重要。

- *DNS域名系统* <br> 一个分布的数据库，它提供将主机名（通常来说是指网址）转换成IP地址的服务。

- *RFC* <br> TCP/IP协议的标准文档

- *端口号port* <br> 是用在TCP，UDP上的一个逻辑号码，并不是一个硬件端口，我们平时说把某某端口封掉了，也只是在IP层次把带有这个号码的IP包给过滤掉了而已。

- *应用编程接口* 通常所说的socket和TLI便是在这里。

<br>

# TCP/IP协议分层

OSI的七层协议经典架构，和TCP/IP协议族的结构对比：

![协议分层](http://blog.csdn.net/images/blog_csdn_net/goodboy1881/193693/r_iso-osi-tcp-1.gif)

TCP/IP协议族按照层次由上到下，层层包装：

- **应用层** 这里就是存放我们熟悉的http、ftp等协议的地方

- **传输层** TCP和UDP协议所在

- **网络层** IP协议，这里主要负责的是给数据加上IP地址和其他数据并确定传输的目标

- **数据链路层** 为待传输的数据加上一个以太网的议头，为以后数据传输做准备

- **物理层** 就是你能看见的硬件东西

<br>
# 数据链路层

这层主要有三个目的:

1. 为IP模板 发送和接受IP数据报

2. 为ARP模板 发送ARP请求和接受ARP应答

3. 为RARP模板 发送RARP请求和接受RARP应答

ARP叫做地址解析协议，是用IP地址换MAC地址的一种协议，而RARP则叫做逆地址解析协议。

<br>

# 网络层

### IP协议

IP协议是TCP/IP协议的核心，所有的TCP，UDP，IMCP，IGCP的数据都以IP数据格式传输。要注意的是，IP不是可靠的协议，这是说，IP协议没有提供一种数据未传达以后的处理机制－－这被认为是上层协议－－TCP或UDP要做的事情。所以这也就出现了TCP是一个可靠的协议，而UDP就没有那么可靠的区别。

###### IP协议头

![IP协议](http://blog.csdn.net/images/blog_csdn_net/goodboy1881/193693/r_ip-protocol.JPG)

在这个协议头中主要注意TTL字段，这个字段规定该数据包在穿过多少个路由之后才会被抛弃(这里就体现出来IP协议包的不可靠性，它不保证数据被送达)，某个ip数据包每穿过一个路由器，该数据包的TTL数值就会减少1，当该数据包的TTL成为零，它就会被自动抛弃。这个字段的最大值也就是255，也就是说一个协议包也就在路由器里面穿行255次就会被抛弃了，根据系统的不同，这个数字也不一样，一般是32或者是64，Tracerouter这个工具就是用这个原理工作的，tranceroute的-m选项要求最大值是255，也就是因为这个TTL在IP协议里面只有8bit。

现在的ip版本号是4，所以也称作IPv4。而其下一代便也是现在经常听说的ipv6了。

###### IP路由选择

稍微一般一点的情况是，主机通过若干个路由器(router)和目的主机连接。那么路由器就要通过ip包的信息来为ip包寻找到一个合适的目标来进行传递，比如合适的主机，或者合适的路由。路由器或者主机将会用如下的方式来处理某一个IP数据包

1. 如果IP数据包的TTL（生命周期）以到，则该IP数据包就被抛弃。
2. 搜索路由表，优先搜索匹配主机，如果能找到和IP地址完全一致的目标主机，则将该包发向目标主机
3. 搜索路由表，如果匹配主机失败，则匹配同子网的路由器，这需要“子网掩码(1.3.)”的协助。如果找到路由器，则将该包发向路由器。
4. 搜索路由表，如果匹配同子网路由器失败，则匹配同网号（第一章有讲解）路由器，如果找到路由器，则将该包发向路由器。
5. 搜索陆游表，如果以上都失败了，就搜索默认路由，如果默认路由存在，则发包
6. 如果都失败了，就丢掉这个包。
这再一次证明了，ip包是不可靠的。因为它不保证送达。

###### 子网寻址

一个IP地址的组成：`网络号码+子网号+主机号`

比如一个B类地址：210.30.109.134。一般情况下，这个IP地址的第一部分（210.30）就是网络号，而第二部分(209)就是子网号，第三部分(134)就是主机号。

至于有多少位代表子网号这个问题上，这没有一个硬性的规定，取而代之的则是子网掩码，校园网相信大多数人都用过，在校园网的设定里面有一个255.255.255.0的东西，这就是子网掩码。子网掩码是由32bit的二进制数字序列,形式为是一连串的1和一连串的0，例如：255.255.255.0(二进制就是11111111.11111111.11111111.00000000)对于刚才的那个B类地址，因为210.30是网络号，那么后面的109.134就是子网号和主机号的组合，又因为子网掩码只有后八bit为0，所以主机号就是IP地址的后八个bit，就是134，而剩下的就是子网号码－－109。 

### ARP协议

ARP（地址解析）协议是一种解析协议，本来主机是完全不知道这个IP对应的是哪个主机的哪个接口，当主机要发送一个IP包的时候，会首先查一下自己的ARP高速缓存（就是一个IP-MAC地址对应表缓存），如果查询的IP－MAC值对不存在，那么主机就向网络发送一个ARP协议广播包，这个广播包里面就有待查询的IP地址，而直接收到这份广播的包的所有主机都会查询自己的IP地址，如果收到广播包的某一个主机发现自己符合条件，那么就准备好一个包含自己的MAC地址的ARP包传送给发送ARP广播的主机，而广播主机拿到ARP包后会更新自己的ARP缓存（就是存放IP-MAC对应表的地方）。发送广播的主机就会用新的ARP缓存数据准备好数据链路层的的数据包发送工作。

### RARP协议
略

### IMCP协议介绍

刚刚在介绍IP协议的时候说到，它并不是一个可靠的协议，它不保证数据被送达，那么，自然的，保证数据送达的工作应该由其他的模块来完成。其中一个重要的模块就是**ICMP(网络控制报文)**协议。

这里我也就简单的介绍一下ICMP协议，其主要是分为两大类：

- 查询报文
	1. PING查询
	2. 子网掩码查询
	3. 时间戳查询（可以用作同步时间）

- 差错报文
	1. 这里主要产生在数据传送发生错误的时候。
	
